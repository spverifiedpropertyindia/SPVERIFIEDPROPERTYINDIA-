<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Add Property - SP Verified Property</title>

  <style>
    body{margin:0;font-family:Arial;background:#f6f7fb}
    header{background:#0b1b3a;color:#fff;padding:16px}
    .wrap{max-width:820px;margin:auto;padding:16px}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.08)}
    label{display:block;margin-top:10px;font-size:12px;color:#555;font-weight:800}
    input,select,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;margin-top:6px}
    textarea{min-height:90px;resize:vertical}
    button{width:100%;padding:12px;margin-top:14px;border:none;border-radius:12px;background:#0b1b3a;color:#fff;font-weight:900;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    a{color:#0b1b3a;text-decoration:none;font-weight:900}
    .mini{font-size:12px;color:#666;line-height:1.4;margin-top:10px}
    .err{font-size:12px;color:#c62828;font-weight:900;margin-top:8px}
    .ok{font-size:12px;color:#0f7a35;font-weight:900;margin-top:8px}
    .row{display:flex;gap:10px}
    .row > div{flex:1}
    .gpsBox{background:#f3f6ff;border:1px solid #dfe6ff;border-radius:12px;padding:10px;margin-top:10px}
    .btnOrange{background:#ff7a00}
    .btnRed{background:#ff3b3b}
    .camBox{margin-top:12px;border:1px solid #eee;border-radius:14px;padding:12px}
    video, canvas, img{width:100%;border-radius:12px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .phCard{border:1px solid #eee;border-radius:12px;padding:8px;background:#fafafa}
    .phCard b{font-size:12px}
    .btnSmall{padding:10px;border-radius:10px;margin-top:8px}
  </style>
</head>

<body>
<header><b>Add Property ‚úÖ (Strict Camera Mode)</b></header>

<div class="wrap">
  <div class="card">
    <p><a href="index.html">‚Üê Home</a></p>
    <div class="mini" id="statusBox">Loading...</div>

    <form id="propForm" style="margin-top:14px;display:none;">
      <label>Property Title</label>
      <input id="title" required placeholder="Eg: 2BHK House near market"/>

      <div class="row">
        <div>
          <label>Type</label>
          <select id="type" required>
            <option value="">Select</option>
            <option value="HOUSE">House</option>
            <option value="PLOT">Plot</option>
            <option value="SHOP">Shop</option>
            <option value="FLAT">Flat</option>
          </select>
        </div>
        <div>
          <label>Price</label>
          <input id="price" required type="number" placeholder="Eg: 1500000"/>
        </div>
      </div>

      <label>Address</label>
      <textarea id="address" required placeholder="Full address..."></textarea>

      <!-- ‚úÖ GPS -->
      <div class="gpsBox">
        <div class="mini"><b>‚úÖ GPS Location (Auto Detect) - Compulsory</b></div>

        <div class="row">
          <div>
            <label>Latitude</label>
            <input id="lat" readonly placeholder="Auto detect..."/>
          </div>
          <div>
            <label>Longitude</label>
            <input id="lng" readonly placeholder="Auto detect..."/>
          </div>
        </div>

        <button type="button" id="gpsBtn" class="btnOrange">üìç Detect GPS Location</button>
        <div class="mini" id="mapLinkBox" style="margin-top:8px;"></div>
      </div>

      <!-- ‚úÖ STRICT CAMERA -->
      <div class="camBox">
        <div class="mini"><b>‚úÖ Strict Mode: Gallery Disabled (Camera only) ‚úÖ</b></div>

        <video id="video" autoplay playsinline style="display:none;"></video>
        <canvas id="canvas" style="display:none;"></canvas>

        <button type="button" id="startCamBtn" class="btnOrange">Start Camera üì∏</button>
        <button type="button" id="stopCamBtn" class="btnRed" style="display:none;">Stop Camera ‚úã</button>

        <div class="mini" id="camStatus">‚ùå Camera OFF</div>

        <div class="grid" style="margin-top:12px;">
          <div class="phCard">
            <b>Photo 1 (Compulsory)</b>
            <img id="p1Preview" style="display:none;margin-top:8px"/>
            <button type="button" class="btnSmall" id="cap1Btn">Capture 1 ‚úÖ</button>
            <button type="button" class="btnSmall btnRed" id="clr1Btn" style="display:none;">Clear 1 ‚ùå</button>
          </div>

          <div class="phCard">
            <b>Photo 2 (Compulsory)</b>
            <img id="p2Preview" style="display:none;margin-top:8px"/>
            <button type="button" class="btnSmall" id="cap2Btn">Capture 2 ‚úÖ</button>
            <button type="button" class="btnSmall btnRed" id="clr2Btn" style="display:none;">Clear 2 ‚ùå</button>
          </div>

          <div class="phCard">
            <b>Photo 3 (Compulsory)</b>
            <img id="p3Preview" style="display:none;margin-top:8px"/>
            <button type="button" class="btnSmall" id="cap3Btn">Capture 3 ‚úÖ</button>
            <button type="button" class="btnSmall btnRed" id="clr3Btn" style="display:none;">Clear 3 ‚ùå</button>
          </div>
        </div>

        <div class="mini" id="photoStatus">‚ùå Minimum 3 photos not captured</div>
      </div>

      <div class="err" id="errBox"></div>
      <div class="ok" id="okBox"></div>

      <button id="submitBtn" type="submit" disabled>Submit Property ‚úÖ</button>
    </form>
  </div>
</div>

<script type="module">
  import { VPI } from "./vpi.js";

  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
  import { getFirestore, doc, setDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";

  const storage = getStorage(getApp());
  const db = getFirestore(getApp());

  const statusBox = document.getElementById("statusBox");
  const form = document.getElementById("propForm");

  const titleEl = document.getElementById("title");
  const typeEl = document.getElementById("type");
  const priceEl = document.getElementById("price");
  const addressEl = document.getElementById("address");

  const latEl = document.getElementById("lat");
  const lngEl = document.getElementById("lng");
  const gpsBtn = document.getElementById("gpsBtn");
  const mapLinkBox = document.getElementById("mapLinkBox");

  const errBox = document.getElementById("errBox");
  const okBox = document.getElementById("okBox");
  const submitBtn = document.getElementById("submitBtn");

  // ‚úÖ Camera
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const startCamBtn = document.getElementById("startCamBtn");
  const stopCamBtn = document.getElementById("stopCamBtn");
  const camStatus = document.getElementById("camStatus");

  const p1Preview = document.getElementById("p1Preview");
  const p2Preview = document.getElementById("p2Preview");
  const p3Preview = document.getElementById("p3Preview");

  const cap1Btn = document.getElementById("cap1Btn");
  const cap2Btn = document.getElementById("cap2Btn");
  const cap3Btn = document.getElementById("cap3Btn");

  const clr1Btn = document.getElementById("clr1Btn");
  const clr2Btn = document.getElementById("clr2Btn");
  const clr3Btn = document.getElementById("clr3Btn");

  const photoStatus = document.getElementById("photoStatus");

  let stream = null;

  // ‚úÖ store captured blobs
  let photo1Blob = null;
  let photo2Blob = null;
  let photo3Blob = null;

  let gpsCapturedAt = 0;

  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));

  function hasGPS(){
    return latEl.value && lngEl.value;
  }

  function getCapturedCount(){
    let c = 0;
    if(photo1Blob) c++;
    if(photo2Blob) c++;
    if(photo3Blob) c++;
    return c;
  }

  function setMapLink(lat, lng){
    const url = `https://www.google.com/maps?q=${lat},${lng}`;
    mapLinkBox.innerHTML = `‚úÖ Maps Link: <a href="${url}" target="_blank">${url}</a>`;
  }

  function validate(){
    errBox.innerText = "";
    okBox.innerText = "";

    const title = titleEl.value.trim();
    const type = typeEl.value;
    const price = Number(priceEl.value || 0);
    const address = addressEl.value.trim();

    if(title.length < 5){
      submitBtn.disabled = true;
      errBox.innerText = "‚ùå Title minimum 5 characters ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è";
      return false;
    }
    if(!type){
      submitBtn.disabled = true;
      errBox.innerText = "‚ùå Property Type select ‡§ï‡§∞‡•ã";
      return false;
    }
    if(!price || price < 1){
      submitBtn.disabled = true;
      errBox.innerText = "‚ùå Price ‡§∏‡§π‡•Ä ‡§°‡§æ‡§≤‡•ã";
      return false;
    }
    if(address.length < 10){
      submitBtn.disabled = true;
      errBox.innerText = "‚ùå Address minimum 10 characters ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è";
      return false;
    }

    // ‚úÖ GPS compulsory + fresh
    if(!hasGPS()){
      submitBtn.disabled = true;
      errBox.innerText = "‚ùå ‡§™‡§π‡§≤‡•á GPS detect ‡§ï‡§∞‡•ã (Detect GPS Location ‡§¶‡§¨‡§æ‡§ì)";
      return false;
    }
    if(!gpsCapturedAt || (Date.now() - gpsCapturedAt) > 5 * 60 * 1000){
      submitBtn.disabled = true;
      errBox.innerText = "‚ùå GPS location ‡§Ö‡§≠‡•Ä-‡§Ö‡§≠‡•Ä detect ‡§ï‡§∞‡•ã (5 min ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞)";
      return false;
    }

    // ‚úÖ camera photos compulsory
    const captured = getCapturedCount();
    if(captured < 3){
      submitBtn.disabled = true;
      photoStatus.innerText = "‚ùå Minimum 3 photos compulsory (‡§Ö‡§¨: " + captured + "/3)";
      errBox.innerText = "‚ùå Camera ‡§∏‡•á 3 photos capture ‡§ï‡§∞‡•ã";
      return false;
    }

    photoStatus.innerText = "‚úÖ 3/3 Photos Captured ‚úÖ";
    submitBtn.disabled = false;
    okBox.innerText = "‚úÖ Property details OK ‚úÖ";
    return true;
  }

  titleEl.addEventListener("input", validate);
  typeEl.addEventListener("change", validate);
  priceEl.addEventListener("input", validate);
  addressEl.addEventListener("input", validate);

  // ‚úÖ GPS detect
  gpsBtn.onclick = async ()=>{
    errBox.innerText = "";
    okBox.innerText = "";
    mapLinkBox.innerHTML = "";

    if(!navigator.geolocation){
      errBox.innerText = "‚ùå GPS/Geolocation supported ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à";
      return;
    }

    gpsBtn.disabled = true;
    gpsBtn.innerText = "Detecting...";

    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        latEl.value = lat;
        lngEl.value = lng;
        gpsCapturedAt = Date.now();
        setMapLink(lat, lng);

        gpsBtn.disabled = false;
        gpsBtn.innerText = "üìç Detect GPS Location";

        okBox.innerText = "‚úÖ GPS location captured!";
        validate();
      },
      (err)=>{
        gpsBtn.disabled = false;
        gpsBtn.innerText = "üìç Detect GPS Location";
        errBox.innerText = "‚ùå GPS permission denied / location unavailable";
        console.log(err);
        validate();
      },
      { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
    );
  };

  // ‚úÖ Camera start/stop
  async function startCamera(){
    try{
      camStatus.innerText = "‚è≥ Starting camera...";
      video.style.display = "block";

      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false
      });

      video.srcObject = stream;

      startCamBtn.style.display = "none";
      stopCamBtn.style.display = "block";
      camStatus.innerText = "‚úÖ Camera ON (Rear)";

    }catch(err){
      camStatus.innerText = "‚ùå Camera permission denied / not supported";
      alert("‚ùå Camera permission denied / not supported");
      console.log(err);
    }
  }

  function stopCamera(){
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    video.srcObject = null;
    video.style.display = "none";
    startCamBtn.style.display = "block";
    stopCamBtn.style.display = "none";
    camStatus.innerText = "‚ùå Camera OFF";
  }

  startCamBtn.onclick = startCamera;
  stopCamBtn.onclick = ()=>{ stopCamera(); validate(); };

  // ‚úÖ Capture helper
  async function capturePhoto(){
    if(!stream) throw new Error("Camera not started");
    await wait(200);

    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 720;

    canvas.width = w;
    canvas.height = h;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);

    const blob = await new Promise((resolve)=>canvas.toBlob(resolve, "image/jpeg", 0.9));
    return blob;
  }

  function setPreview(previewEl, blob){
    previewEl.src = URL.createObjectURL(blob);
    previewEl.style.display = "block";
  }

  // ‚úÖ Capture buttons
  cap1Btn.onclick = async ()=>{
    try{
      const b = await capturePhoto();
      photo1Blob = b;
      setPreview(p1Preview, b);
      clr1Btn.style.display = "block";
      validate();
    }catch(e){ alert("‚ùå Start camera first"); }
  };

  cap2Btn.onclick = async ()=>{
    try{
      const b = await capturePhoto();
      photo2Blob = b;
      setPreview(p2Preview, b);
      clr2Btn.style.display = "block";
      validate();
    }catch(e){ alert("‚ùå Start camera first"); }
  };

  cap3Btn.onclick = async ()=>{
    try{
      const b = await capturePhoto();
      photo3Blob = b;
      setPreview(p3Preview, b);
      clr3Btn.style.display = "block";
      validate();
    }catch(e){ alert("‚ùå Start camera first"); }
  };

  // ‚úÖ Clear buttons
  clr1Btn.onclick = ()=>{
    photo1Blob = null;
    p1Preview.style.display = "none";
    clr1Btn.style.display = "none";
    validate();
  };

  clr2Btn.onclick = ()=>{
    photo2Blob = null;
    p2Preview.style.display = "none";
    clr2Btn.style.display = "none";
    validate();
  };

  clr3Btn.onclick = ()=>{
    photo3Blob = null;
    p3Preview.style.display = "none";
    clr3Btn.style.display = "none";
    validate();
  };

  async function refresh(){
    const u = VPI.currentUser();
    if(!u){
      statusBox.innerHTML = `‚ùå Not logged in. <a href="user-login.html">Login</a>`;
      form.style.display = "none";
      return;
    }
    statusBox.innerHTML = `‚úÖ Logged in: <b>${u.email}</b>`;
    form.style.display = "block";
    validate();
  }

  async function uploadBlob(path, blob){
    const r = ref(storage, path);
    await uploadBytes(r, blob);
    return await getDownloadURL(r);
  }

  // ‚úÖ Submit Property
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!validate()) return;

    const u = VPI.currentUser();
    if(!u) return alert("‚ùå Login required");

    submitBtn.disabled = true;
    submitBtn.innerText = "Uploading...";

    try{
      const basePath = `properties/${u.uid}/${Date.now()}`;

      // ‚úÖ Upload 3 photos only (strict)
      const url1 = await uploadBlob(`${basePath}_photo_1.jpg`, photo1Blob);
      const url2 = await uploadBlob(`${basePath}_photo_2.jpg`, photo2Blob);
      const url3 = await uploadBlob(`${basePath}_photo_3.jpg`, photo3Blob);

      const photoUrls = [url1, url2, url3];

      // ‚úÖ Ensure user doc exists
      await setDoc(doc(db, "users", u.uid), {
        uid: u.uid,
        email: u.email
      }, { merge: true });

      // ‚úÖ Save property
      await addDoc(collection(db, "properties"), {
        uid: u.uid,
        ownerEmail: u.email,

        title: titleEl.value.trim(),
        type: typeEl.value,
        price: Number(priceEl.value),
        address: addressEl.value.trim(),

        gpsLat: Number(latEl.value),
        gpsLng: Number(lngEl.value),
        gpsCapturedAt: gpsCapturedAt,
        gpsMapLink: `https://www.google.com/maps?q=${latEl.value},${lngEl.value}`,

        photos: photoUrls,
        photoCount: 3,

        status: "PENDING",
        createdAt: serverTimestamp()
      });

      alert("‚úÖ Property Submitted! Camera Photos + GPS Saved ‚úÖ (Status = PENDING)");
      location.href = "index.html";

    }catch(err){
      alert("‚ùå Submit Failed: " + (err.message || err));
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit Property ‚úÖ";
    }
  });

  setTimeout(refresh, 800);
</script>

</body>
</html>