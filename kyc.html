<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KYC Submit - SP Verified Property</title>

  <style>
    body{margin:0;font-family:Arial;background:#f6f7fb}
    header{background:#0b1b3a;color:#fff;padding:16px}
    .wrap{max-width:720px;margin:auto;padding:16px}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.08)}
    label{display:block;margin-top:10px;font-size:12px;color:#555;font-weight:800}
    input,select{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;margin-top:6px}
    button{width:100%;padding:12px;margin-top:14px;border:none;border-radius:12px;background:#0b1b3a;color:#fff;font-weight:900;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    a{color:#0b1b3a;text-decoration:none;font-weight:900}
    .mini{font-size:12px;color:#666;line-height:1.4;margin-top:10px}
    .err{font-size:12px;color:#c62828;font-weight:900;margin-top:8px}
    .ok{font-size:12px;color:#0f7a35;font-weight:900;margin-top:8px}

    .camBox{margin-top:10px;border:1px solid #eee;border-radius:14px;padding:10px}
    video, canvas, img{width:100%;border-radius:12px}
    .row{display:flex;gap:10px;margin-top:10px}
    .row button{width:50%;margin-top:0}
    .btnOrange{background:#ff7a00}
    .btnRed{background:#ff3b3b}
  </style>
</head>

<body>
<header><b>KYC Submit ‚úÖ</b></header>

<div class="wrap">
  <div class="card">
    <p><a href="index.html">‚Üê Home</a></p>

    <div class="mini" id="statusBox">Loading...</div>

    <form id="kycForm" style="margin-top:14px;display:none;">

      <label>Select KYC Type (Compulsory)</label>
      <select id="kycType" required>
        <option value="">Select</option>
        <option value="AADHAAR">Aadhaar Card (Front + Back)</option>
        <option value="PAN">PAN Card (Single)</option>
        <option value="VOTER">Voter ID (Front + Back)</option>
      </select>

      <label>KYC Number (Compulsory)</label>
      <input id="kycNumber" required placeholder="Enter valid number"/>

      <!-- ‚úÖ FRONT / BACK Uploads -->
      <div id="frontBackBox" style="display:none;">
        <label>Upload Front Side (Compulsory)</label>
        <input id="frontFile" type="file" accept="image/*,application/pdf" />

        <label>Upload Back Side (Compulsory)</label>
        <input id="backFile" type="file" accept="image/*,application/pdf" />
      </div>

      <!-- ‚úÖ SINGLE Upload -->
      <div id="singleBox" style="display:none;">
        <label>Upload PAN Document (Compulsory)</label>
        <input id="singleFile" type="file" accept="image/*,application/pdf" />
      </div>

      <!-- ‚úÖ LIVE PHOTO SECTION -->
      <div class="camBox">
        <div class="mini"><b>‚úÖ Live Photo (Camera Selfie) ‚Äì Compulsory</b></div>

        <video id="video" autoplay playsinline style="display:none;"></video>
        <canvas id="canvas" style="display:none;"></canvas>

        <img id="previewImg" style="display:none;" alt="Selfie Preview"/>

        <div class="row">
          <button type="button" id="startCamBtn" class="btnOrange">Start Camera üì∏</button>
          <button type="button" id="captureBtn" disabled>Capture ‚úÖ</button>
        </div>

        <div class="row">
          <button type="button" id="retakeBtn" class="btnRed" style="display:none;">Retake üîÑ</button>
          <button type="button" id="stopCamBtn" style="display:none;">Stop Camera ‚úã</button>
        </div>

        <div class="mini" id="selfieStatus">‚ùå Live selfie not captured</div>
      </div>

      <div class="err" id="errBox"></div>
      <div class="ok" id="okBox"></div>

      <button id="submitBtn" type="submit" disabled>Submit KYC ‚úÖ</button>
    </form>

    <div class="mini">
      ‚úÖ Note: Submit ke baad Admin verify karke approve/reject karega.
    </div>
  </div>
</div>

<script type="module">
  import { VPI } from "./vpi.js";

  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
  import { getFirestore, doc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";

  const storage = getStorage(getApp());
  const db = getFirestore(getApp());

  const statusBox = document.getElementById("statusBox");
  const form = document.getElementById("kycForm");

  const kycType = document.getElementById("kycType");
  const kycNumber = document.getElementById("kycNumber");

  const frontBackBox = document.getElementById("frontBackBox");
  const singleBox = document.getElementById("singleBox");

  const frontFile = document.getElementById("frontFile");
  const backFile = document.getElementById("backFile");
  const singleFile = document.getElementById("singleFile");

  const errBox = document.getElementById("errBox");
  const okBox = document.getElementById("okBox");
  const submitBtn = document.getElementById("submitBtn");

  // ‚úÖ Camera elements
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const previewImg = document.getElementById("previewImg");

  const startCamBtn = document.getElementById("startCamBtn");
  const captureBtn = document.getElementById("captureBtn");
  const retakeBtn = document.getElementById("retakeBtn");
  const stopCamBtn = document.getElementById("stopCamBtn");
  const selfieStatus = document.getElementById("selfieStatus");

  let stream = null;
  let selfieBlob = null;

  function cleanText(v){ return (v||"").trim(); }

  // ‚úÖ Aadhaar = 12 digits
  function isValidAadhaar(a){
    const v = cleanText(a);
    if(!/^[0-9]{12}$/.test(v)) return false;
    if(/^(\d)\1{11}$/.test(v)) return false;
    return true;
  }

  // ‚úÖ PAN = AAAAA9999A
  function isValidPAN(p){
    const v = cleanText(p).toUpperCase();
    return /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(v);
  }

  // ‚úÖ Voter = AAA9999999 (basic)
  function isValidVoterId(voter){
    const v = cleanText(voter).toUpperCase();
    return /^[A-Z]{3}[0-9]{7}$/.test(v);
  }

  function updateUploadUI(){
    const type = kycType.value;

    // Reset file inputs
    frontFile.value = "";
    backFile.value = "";
    singleFile.value = "";

    if(type === "AADHAAR" || type === "VOTER"){
      frontBackBox.style.display = "block";
      singleBox.style.display = "none";
    } else if(type === "PAN"){
      frontBackBox.style.display = "none";
      singleBox.style.display = "block";
    } else {
      frontBackBox.style.display = "none";
      singleBox.style.display = "none";
    }
  }

  function validate(){
    errBox.innerText = "";
    okBox.innerText = "";

    const type = kycType.value;
    let num = cleanText(kycNumber.value);

    if(!type){
      submitBtn.disabled = true;
      errBox.innerText = "‚ùå KYC Type select karna compulsory hai";
      return false;
    }

    if(!num){
      submitBtn.disabled = true;
      errBox.innerText = "‚ùå KYC Number dalna compulsory hai";
      return false;
    }

    if(type === "PAN" || type === "VOTER"){
      kycNumber.value = num.toUpperCase();
      num = kycNumber.value;
    }

    if(type === "AADHAAR" && !isValidAadhaar(num)){
      submitBtn.disabled = true;
      errBox.innerText = "‚ùå Invalid Aadhaar (12 digits only)";
      return false;
    }

    if(type === "PAN" && !isValidPAN(num)){
      submitBtn.disabled = true;
      errBox.innerText = "‚ùå Invalid PAN (Format: ABCDE1234F)";
      return false;
    }

    if(type === "VOTER" && !isValidVoterId(num)){
      submitBtn.disabled = true;
      errBox.innerText = "‚ùå Invalid Voter ID (Format: ABC1234567)";
      return false;
    }

    // ‚úÖ Document checks
    if(type === "AADHAAR" || type === "VOTER"){
      if(!frontFile.files || frontFile.files.length === 0){
        submitBtn.disabled = true;
        errBox.innerText = "‚ùå Front side upload compulsory hai";
        return false;
      }
      if(!backFile.files || backFile.files.length === 0){
        submitBtn.disabled = true;
        errBox.innerText = "‚ùå Back side upload compulsory hai";
        return false;
      }
    }

    if(type === "PAN"){
      if(!singleFile.files || singleFile.files.length === 0){
        submitBtn.disabled = true;
        errBox.innerText = "‚ùå PAN document upload compulsory hai";
        return false;
      }
    }

    // ‚úÖ Live selfie compulsory
    if(!selfieBlob){
      submitBtn.disabled = true;
      errBox.innerText = "‚ùå Live Selfie capture compulsory hai";
      return false;
    }

    submitBtn.disabled = false;
    okBox.innerText = "‚úÖ KYC OK (Docs + Live Selfie captured)";
    return true;
  }

  // ‚úÖ CAMERA CONTROLS
  startCamBtn.onclick = async () => {
    try{
      selfieStatus.innerText = "‚è≥ Opening camera...";
      previewImg.style.display = "none";
      video.style.display = "block";

      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      });

      video.srcObject = stream;
      captureBtn.disabled = false;
      stopCamBtn.style.display = "block";
      retakeBtn.style.display = "none";
      selfieStatus.innerText = "‚úÖ Camera ON. Capture selfie ‚úÖ";
    }catch(err){
      alert("‚ùå Camera permission denied / not supported");
      selfieStatus.innerText = "‚ùå Camera error";
      console.log(err);
    }
  };

  function stopCamera(){
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    video.style.display = "none";
    captureBtn.disabled = true;
    stopCamBtn.style.display = "none";
  }

  stopCamBtn.onclick = () => {
    stopCamera();
    selfieStatus.innerText = "‚ùå Camera stopped";
    validate();
  };

  captureBtn.onclick = async () => {
    try{
      if(!stream) return alert("‚ùå Camera not started");

      const w = video.videoWidth || 720;
      const h = video.videoHeight || 720;

      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);

      const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/jpeg", 0.9));
      selfieBlob = blob;

      previewImg.src = URL.createObjectURL(blob);
      previewImg.style.display = "block";

      stopCamera();

      retakeBtn.style.display = "block";
      selfieStatus.innerText = "‚úÖ Live selfie captured ‚úÖ";

      validate();
    }catch(err){
      alert("‚ùå Capture failed");
      console.log(err);
    }
  };

  retakeBtn.onclick = () => {
    selfieBlob = null;
    previewImg.style.display = "none";
    selfieStatus.innerText = "‚ùå Live selfie not captured";
    validate();
  };

  // ‚úÖ EVENTS
  kycType.addEventListener("change", () => {
    updateUploadUI();
    validate();
  });

  kycNumber.addEventListener("input", validate);
  frontFile.addEventListener("change", validate);
  backFile.addEventListener("change", validate);
  singleFile.addEventListener("change", validate);

  // ‚úÖ AUTH REFRESH
  async function refresh(){
    const u = VPI.currentUser();
    if(!u){
      statusBox.innerHTML = `‚ùå Not logged in. <a href="user-login.html">Login</a>`;
      form.style.display = "none";
      return;
    }

    statusBox.innerHTML = `‚úÖ Logged in: <b>${u.email}</b>`;
    form.style.display = "block";
    updateUploadUI();
    validate();
  }

  // ‚úÖ UPLOAD HELPERS
  async function uploadFile(path, fileOrBlob){
    const r = ref(storage, path);
    await uploadBytes(r, fileOrBlob);
    return await getDownloadURL(r);
  }

  // ‚úÖ SUBMIT = Upload + Firestore PENDING
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!validate()) return;

    const u = VPI.currentUser();
    if(!u) return alert("‚ùå Login required");

    submitBtn.disabled = true;
    submitBtn.innerText = "Uploading...";

    try{
      const type = kycType.value;
      const number = kycNumber.value.trim();

      const basePath = `kyc/${u.uid}/${Date.now()}`;

      let frontUrl = "";
      let backUrl = "";
      let singleUrl = "";

      // ‚úÖ Upload docs
      if(type === "AADHAAR" || type === "VOTER"){
        const front = frontFile.files[0];
        const back = backFile.files[0];

        frontUrl = await uploadFile(`${basePath}_front`, front);
        backUrl = await uploadFile(`${basePath}_back`, back);
      }

      if(type === "PAN"){
        const single = singleFile.files[0];
        singleUrl = await uploadFile(`${basePath}_pan`, single);
      }

      // ‚úÖ Upload live selfie blob
      const selfieUrl = await uploadFile(`${basePath}_selfie.jpg`, selfieBlob);

      // ‚úÖ Ensure user doc exists
      await setDoc(doc(db, "users", u.uid), {
        email: u.email,
        uid: u.uid
      }, { merge: true });

      // ‚úÖ Save status = PENDING (Admin approve later)
      await updateDoc(doc(db, "users", u.uid), {
        kycType: type,
        kycNumber: number,

        kycDocFrontUrl: frontUrl,
        kycDocBackUrl: backUrl,
        kycDocSingleUrl: singleUrl,
        kycSelfieUrl: selfieUrl,

        kycStatus: "PENDING",
        kycSubmittedAt: serverTimestamp()
      });

      alert("‚úÖ KYC Submitted Successfully! Status = PENDING ‚úÖ");
      location.href = "index.html";

    }catch(err){
      alert("‚ùå KYC Submit Failed: " + (err.message || err));
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit KYC ‚úÖ";
    }
  });

  setTimeout(refresh, 800);
</script>

</body>
</html>