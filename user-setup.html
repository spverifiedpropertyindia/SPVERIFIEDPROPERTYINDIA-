<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>User Setup - SP Verified Property</title>

  <style>
    body{margin:0;font-family:Arial;background:#f6f7fb}
    header{background:#0b1b3a;color:#fff;padding:16px}
    .wrap{max-width:720px;margin:auto;padding:16px}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.08)}
    input,select{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;margin-top:6px}
    label{display:block;margin-top:10px;font-size:12px;color:#555;font-weight:800}
    button{width:100%;padding:12px;margin-top:14px;border:none;border-radius:12px;background:#0b1b3a;color:#fff;font-weight:900;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    a{color:#0b1b3a;text-decoration:none;font-weight:900}
    .mini{font-size:12px;color:#666;line-height:1.4;margin-top:10px}
    .err{font-size:12px;color:#c62828;font-weight:900;margin-top:8px}
    .ok{font-size:12px;color:#0f7a35;font-weight:900;margin-top:8px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#d4edda;color:#0f7a35;font-weight:900;font-size:12px}
  </style>
</head>

<body>
<header><b>User Setup ✅</b></header>

<div class="wrap">
  <div class="card">
    <p><a href="index.html">← Home</a></p>

    <div class="mini" id="statusBox">Loading...</div>

    <div class="mini" style="margin-top:10px;">
      <span class="pill">✅ Setup save होने के बाद KYC compulsory है</span>
    </div>

    <form id="setupForm" style="margin-top:14px;display:none;">
      <label>Full Name</label>
      <input id="name" required placeholder="Enter your full name"/>

      <label>Mobile Number (10 digits)</label>
      <input id="mobile" required placeholder="Enter mobile number" maxlength="10"/>

      <label>Role (Compulsory)</label>
      <select id="role" required>
        <option value="">Select</option>
        <option value="OWNER">Owner</option>
        <option value="BROKER">Broker</option>
        <option value="BUYER">Buyer</option>
        <option value="SELLER">Seller</option>
      </select>

      <div class="err" id="errBox"></div>
      <div class="ok" id="okBox"></div>

      <button id="saveBtn" type="submit" disabled>Save & Continue ✅</button>
    </form>

    <div class="mini">
      ✅ Note: गलत mobile / fake details allow नहीं होंगे ✅
    </div>
  </div>
</div>

<script type="module">
  import { VPI } from "./vpi.js";

  import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";

  const db = getFirestore(getApp());

  const statusBox = document.getElementById("statusBox");
  const setupForm = document.getElementById("setupForm");

  const nameEl = document.getElementById("name");
  const mobileEl = document.getElementById("mobile");
  const roleEl = document.getElementById("role");

  const errBox = document.getElementById("errBox");
  const okBox = document.getElementById("okBox");
  const saveBtn = document.getElementById("saveBtn");

  function validMobile(m){
    const v = (m || "").trim();
    if(!/^[0-9]{10}$/.test(v)) return false;
    if(/^(\d)\1{9}$/.test(v)) return false; // 0000000000
    if(!/^[6-9]/.test(v)) return false; // India mobile starts with 6-9
    return true;
  }

  function validate(){
    errBox.innerText = "";
    okBox.innerText = "";

    const name = nameEl.value.trim();
    const mobile = mobileEl.value.trim();
    const role = roleEl.value;

    if(name.length < 3){
      saveBtn.disabled = true;
      errBox.innerText = "❌ Name minimum 3 characters होना चाहिए";
      return false;
    }

    if(!validMobile(mobile)){
      saveBtn.disabled = true;
      errBox.innerText = "❌ Mobile number गलत है (10 digits valid number डालो)";
      return false;
    }

    if(!role){
      saveBtn.disabled = true;
      errBox.innerText = "❌ Role select करना compulsory है";
      return false;
    }

    saveBtn.disabled = false;
    okBox.innerText = "✅ Details OK";
    return true;
  }

  nameEl.addEventListener("input", validate);
  mobileEl.addEventListener("input", validate);
  roleEl.addEventListener("change", validate);

  async function loadUser(){
    const u = VPI.requireLogin();

    statusBox.innerHTML = `✅ Logged in: <b>${u.email}</b>`;
    setupForm.style.display = "block";

    // ✅ Autofill if already saved
    try{
      const snap = await getDoc(doc(db, "users", u.uid));
      if(snap.exists()){
        const data = snap.data();
        if(data.name) nameEl.value = data.name;
        if(data.mobile) mobileEl.value = data.mobile;
        if(data.role) roleEl.value = data.role;
      }
    }catch(e){
      console.log(e);
    }

    validate();
  }

  setupForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!validate()) return;

    const u = VPI.requireLogin();

    saveBtn.disabled = true;
    saveBtn.innerText = "Saving...";

    try{
      await setDoc(doc(db, "users", u.uid), {
        uid: u.uid,
        email: u.email,
        name: nameEl.value.trim(),
        mobile: mobileEl.value.trim(),
        role: roleEl.value,
        updatedAt: serverTimestamp(),
        createdAt: serverTimestamp()
      }, { merge: true });

      alert("✅ User Setup Saved Successfully! अब KYC करना compulsory है ✅");
      location.href = "kyc.html";

    }catch(err){
      alert("❌ Save Failed: " + (err.message || err));
      saveBtn.disabled = false;
      saveBtn.innerText = "Save & Continue ✅";
    }
  });

  setTimeout(loadUser, 800);
</script>

</body>
</html>