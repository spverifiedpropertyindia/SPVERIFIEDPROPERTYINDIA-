<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Buy Plan - SP Verified Property India</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>

<div class="nav">
  <div class="logo">üí≥ Buy Plan</div>
  <div class="menu">
    <a href="index.html">Home</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="admin.html" id="adminLink" style="display:none;">Admin</a>
  </div>
</div>

<div class="container">

  <div class="box">
    <h2>‚úÖ Plans Validity</h2>
    <p class="small">‚úÖ BASIC = 28 days | ‚úÖ STANDARD = 56 days | ‚úÖ PREMIUM = 84 days</p>
    <p class="small" style="margin-top:8px;">
      UPI ID: <b>8305070599@superyes</b>
      <button class="btn2" onclick="navigator.clipboard.writeText('8305070599@superyes')">Copy</button>
    </p>
  </div>

  <!-- ‚úÖ ADMIN MODE BOX -->
  <div id="adminBox"></div>

  <div class="box" style="margin-top:14px;">
    <h2>Select Plan</h2>

    <label>Select Role</label>
    <select id="role" onchange="payNowUPI()">
      <option value="OWNER">OWNER</option>
      <option value="BROKER">BROKER</option>
    </select>

    <label>Select Plan</label>
    <select id="plan" onchange="payNowUPI()">
      <option value="BASIC">BASIC (28 Days)</option>
      <option value="STANDARD">STANDARD (56 Days)</option>
      <option value="PREMIUM">PREMIUM (84 Days)</option>
    </select>

    <label>Amount (Auto)</label>
    <input id="amount" readonly />

    <!-- ‚úÖ Backup Button (PAID PLAN ONLY => BASIC me HIDE) -->
    <div style="margin-top:12px;" id="qrBtnBox">
      <button class="btn" style="width:100%;" onclick="generateQR()">
        Generate QR & Pay (Backup)
      </button>
    </div>

    <div id="payBox" style="margin-top:12px;"></div>

    <hr style="margin:14px 0;border:0;border-top:1px solid #eee;"/>

    <!-- ‚úÖ UTR BOX (PAID PLAN ONLY => BASIC me HIDE) -->
    <div id="utrBox">
      <h2>Submit Transaction (UTR)</h2>
      <p class="small">Payment ke baad UTR submit karein. Admin approve karega.</p>

      <label>UTR / Transaction ID</label>
      <input id="utr" placeholder="Enter UTR (Minimum 10 digits)" />
    </div>

    <button class="btn" style="width:100%;margin-top:12px;" onclick="submitPayment()">
      Submit For Approval
    </button>

    <p class="small" id="msg" style="margin-top:10px;"></p>
  </div>

  <div class="footer">
    ‚úÖ WhatsApp Support:
    <a href="https://wa.me/918305070599" target="_blank"><b>8305070599</b></a>
    &nbsp; | &nbsp;
    ‚úÖ Support Email:
    <a href="mailto:spverifiedproperty@gmail.com"><b>spverifiedproperty@gmail.com</b></a>
  </div>

</div>

<script type="module">
  import { db } from "./js/firebase.js";
  import { listenUser } from "./js/auth.js";

  import {
    doc, getDoc,
    addDoc, collection,
    updateDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const ADMIN_EMAIL = "raazsahu1000@gmail.com";
  const UPI_ID = "8305070599@superyes";
  let currentUser = null;

  const amountInput = document.getElementById("amount");
  const msg = document.getElementById("msg");
  const payBox = document.getElementById("payBox");

  const adminBox = document.getElementById("adminBox");
  const adminLink = document.getElementById("adminLink");

  const PRICES = {
    OWNER: { BASIC: 0, STANDARD: 299, PREMIUM: 499 },
    BROKER:{ BASIC: 0, STANDARD: 499, PREMIUM: 699 }
  };

  // ‚úÖ Amount update + BASIC me UTR/QR hide
  function updateAmount(){
    const role = document.getElementById("role").value;
    const plan = document.getElementById("plan").value;

    const amount = PRICES[role][plan];
    amountInput.value = amount;

    const utrBox = document.getElementById("utrBox");
    const utrInput = document.getElementById("utr");
    const qrBtnBox = document.getElementById("qrBtnBox");

    // ‚úÖ BASIC (FREE) => UTR & QR hide
    if(amount === 0){
      utrBox.style.display = "none";
      qrBtnBox.style.display = "none";
      payBox.innerHTML = "";
      utrInput.value = "";
      msg.innerHTML = "‚úÖ BASIC (Free) plan selected. No payment needed. Submit to Activate.";
    }else{
      // ‚úÖ Paid plans => Show UTR & QR
      utrBox.style.display = "block";
      qrBtnBox.style.display = "block";
      msg.innerHTML = "";
    }
  }

  // ‚úÖ initial update
  updateAmount();

  listenUser(async (u)=>{
    if(!u){
      alert("Login required!");
      location.href="login.html";
      return;
    }

    currentUser = u;
    const isAdmin = (u.email === ADMIN_EMAIL);

    // ‚úÖ Admin UI (NO RETURN HERE ‚úÖ)
    if(isAdmin){
      if(adminLink) adminLink.style.display = "inline-block";
      if(adminBox){
        adminBox.innerHTML = `
          <div class="box" style="margin-top:14px;">
            <h3>üõ° ADMIN MODE ENABLED</h3>
            <p class="small">
              ‚úÖ Admin ko KYC requirement nahi hai.<br/>
              ‚úÖ Admin full access ‚úÖ
            </p>
          </div>
        `;
      }
      // ‚úÖ DO NOT RETURN ‚úÖ
      return;
    }

    // ‚úÖ Normal user must have KYC approved
    const userSnap = await getDoc(doc(db,"users",u.uid));
    if(userSnap.exists()){
      const ud = userSnap.data();
      if(ud.kycStatus !== "APPROVED"){
        alert("KYC not approved! Pehle KYC approve karvao.");
        location.href="kyc.html";
        return;
      }
    }
  });

  // ‚úÖ Payment Done helper focus
  window.paymentDoneFocus = function(){
    const utrInput = document.getElementById("utr");
    if(utrInput) utrInput.focus();
    msg.innerHTML = "‚úÖ Please enter UTR / Transaction ID and Submit for Approval.";
  };

  // ‚úÖ Auto open UPI App on select plan/role (PAID PLANS ONLY)
  window.payNowUPI = function(){
    updateAmount();

    const role = document.getElementById("role").value;
    const plan = document.getElementById("plan").value;
    const amount = PRICES[role][plan];

    payBox.innerHTML = "";

    // ‚úÖ BASIC => No UPI popup
    if(amount === 0){
      msg.innerHTML = "‚úÖ BASIC (Free) plan selected. No payment needed. Submit to Activate.";
      return;
    }

    const ok = confirm(`Pay ‚Çπ${amount} for ${role} - ${plan} Plan using UPI App?`);
    if(!ok){
      msg.innerHTML = "‚ùå Payment cancelled. You can use QR Backup button.";
      return;
    }

    const note = `${role}-${plan}-Plan`;
    const upiUrl = `upi://pay?pa=${UPI_ID}&pn=SP%20Verified%20Property%20India&am=${amount}&cu=INR&tn=${encodeURIComponent(note)}`;

    msg.innerHTML = "‚è≥ Opening UPI App (PhonePe/GPay/Paytm)...";

    setTimeout(()=>{
      payBox.innerHTML = `
        <div style="text-align:center;">
          <h3>‚úÖ Payment Done?</h3>
          <p class="small">Agar aapne payment kar diya hai to UTR/Transaction ID niche ‡§°‡§æ‡§≤‡•á‡§Ç.</p>
          <button class="btn" style="width:100%;margin-top:10px;" onclick="paymentDoneFocus()">
            ‚úÖ I Have Paid (Enter UTR)
          </button>
          <p class="small" style="margin-top:8px;color:#777;">
            Agar UPI app open nahi hua to ‡§®‡•Ä‡§ö‡•á "Generate QR & Pay (Backup)" use karein.
          </p>
        </div>
      `;
    }, 1200);

    window.location.href = upiUrl;
  };

  // ‚úÖ Backup: Generate QR (PAID PLANS ONLY)
  window.generateQR = function(){
    updateAmount();

    const role = document.getElementById("role").value;
    const plan = document.getElementById("plan").value;
    const amount = PRICES[role][plan];

    // ‚úÖ BASIC => QR generate nahi
    if(amount === 0){
      payBox.innerHTML = `
        <div style="text-align:center;">
          <h3>‚úÖ BASIC (Free) Plan</h3>
          <p class="small">Payment required nahi hai.</p>
        </div>
      `;
      return;
    }

    const note = `${role}-${plan}-Plan`;
    const upiUrl = `upi://pay?pa=${UPI_ID}&pn=SP%20Verified%20Property%20India&am=${amount}&cu=INR&tn=${encodeURIComponent(note)}`;
    const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=" + encodeURIComponent(upiUrl);

    payBox.innerHTML = `
      <div style="text-align:center;">
        <h3>Scan & Pay ‚Çπ${amount}</h3>
        <img src="${qrUrl}" style="border-radius:16px;border:1px solid #eee;margin-top:10px;" />
        <p class="small" style="margin-top:8px;"><b>UPI:</b> ${UPI_ID}</p>
        <p class="small" style="color:#777;">‚úÖ Payment ke baad UTR niche submit karein</p>
      </div>
    `;
  };

  // ‚úÖ Submit Payment / Activate Plan
  window.submitPayment = async function(){
    if(!currentUser) return;

    const role = document.getElementById("role").value;
    const plan = document.getElementById("plan").value;
    const amount = PRICES[role][plan];

    const utrInput = document.getElementById("utr");
    const utr = (utrInput ? utrInput.value.trim() : "");

    // ‚úÖ FREE PLAN: Direct Activate
    if(amount === 0){
      await updateDoc(doc(db,"users",currentUser.uid),{
        planRole: role,
        planType: plan,
        planAmount: 0,
        planStatus: "ACTIVE",
        paymentMode: "FREE",
        utr: "",
        planUpdatedAt: serverTimestamp()
      });

      msg.innerHTML = "‚úÖ Free Plan Activated Successfully!";
      alert("‚úÖ Free Plan Activated Successfully!");
      if(utrInput) utrInput.value = "";
      return;
    }

    // ‚úÖ Paid Plan => UTR compulsory
    if(!utr){
      alert("‚ùå UTR required!");
      if(utrInput) utrInput.focus();
      return;
    }

    if(!/^\d+$/.test(utr)){
      alert("‚ùå UTR must be numbers only!");
      if(utrInput) utrInput.focus();
      return;
    }

    if(utr.length < 10){
      alert("‚ùå UTR minimum 10 digits compulsory!");
      if(utrInput) utrInput.focus();
      return;
    }

    await addDoc(collection(db,"payments"),{
      uid: currentUser.uid,
      email: currentUser.email,
      role,
      plan,
      amount,
      utr,
      upiId: UPI_ID,
      paymentMode: "UPI_APP_OR_QR",
      status: "PENDING",
      createdAt: serverTimestamp()
    });

    msg.innerHTML = "‚úÖ Payment Submitted! Admin approval pending.";
    if(utrInput) utrInput.value = "";
  };
</script>

</body>
  </html>
