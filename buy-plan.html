<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Buy Plan - SP Verified Property India</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>

<div class="nav">
  <div class="logo">üí≥ Buy Plan</div>
  <div class="menu">
    <a href="index.html">Home</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="admin.html" id="adminLink" style="display:none;">Admin</a>
  </div>
</div>

<div class="container">

  <div class="box">
    <h2>‚úÖ Plans Validity</h2>
    <p class="small">‚úÖ BASIC = 28 days | ‚úÖ STANDARD = 56 days | ‚úÖ PREMIUM = 84 days</p>
    <p class="small" style="margin-top:8px;">
      UPI ID: <b>8305070599@superyes</b>
      <button class="btn2" onclick="navigator.clipboard.writeText('8305070599@superyes')">Copy</button>
    </p>
  </div>

  <!-- ‚úÖ ADMIN MODE BOX -->
  <div id="adminBox"></div>

  <div class="box" style="margin-top:14px;">
    <h2>Select Plan</h2>

    <label>Select Role</label>
    <select id="role">
      <option value="OWNER">OWNER</option>
      <option value="BROKER">BROKER</option>
    </select>

    <label>Select Plan</label>
    <select id="plan">
      <option value="BASIC">BASIC (28 Days)</option>
      <option value="STANDARD">STANDARD (56 Days)</option>
      <option value="PREMIUM">PREMIUM (84 Days)</option>
    </select>

    <label>Amount (Auto)</label>
    <input id="amount" readonly />

    <div style="margin-top:12px;">
      <!-- ‚úÖ Now opens Razorpay -->
      <button class="btn" style="width:100%;" onclick="payNow()">Pay Now (Razorpay)</button>
    </div>

    <div id="payBox" style="margin-top:12px;"></div>

    <hr style="margin:14px 0;border:0;border-top:1px solid #eee;"/>

    <h2>Submit Transaction (UTR)</h2>
    <p class="small">Payment ke baad UTR submit karein. Admin approve karega.</p>

    <label>UTR / Transaction ID</label>
    <input id="utr" placeholder="Enter UTR / Razorpay Payment ID" />

    <button class="btn" style="width:100%;margin-top:12px;" onclick="submitPayment()">
      Submit For Approval
    </button>

    <p class="small" id="msg" style="margin-top:10px;"></p>
  </div>

  <div class="footer">
    ‚úÖ WhatsApp Support:
    <a href="https://wa.me/918305070599" target="_blank"><b>8305070599</b></a>
    &nbsp; | &nbsp;
    ‚úÖ Support Email:
    <a href="mailto:spverifiedproperty@gmail.com"><b>spverifiedproperty@gmail.com</b></a>
  </div>

</div>

<!-- ‚úÖ Razorpay Checkout -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script type="module">
  import { db } from "./js/firebase.js";
  import { listenUser } from "./js/auth.js";

  import {
    doc, getDoc,
    addDoc, collection,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const ADMIN_EMAIL = "raazsahu1000@gmail.com";

  // ‚úÖ Razorpay Key ID (aapne diya)
  const RAZORPAY_KEY = "S7IlZ9gUrb0Zny";

  // ‚úÖ UPI (Optional)
  const UPI_ID = "8305070599@superyes";

  let currentUser = null;

  const amountInput = document.getElementById("amount");
  const msg = document.getElementById("msg");
  const payBox = document.getElementById("payBox");

  const adminBox = document.getElementById("adminBox");
  const adminLink = document.getElementById("adminLink");

  const PRICES = {
    OWNER: { BASIC: 0, STANDARD: 299, PREMIUM: 499 },
    BROKER:{ BASIC: 0, STANDARD: 499, PREMIUM: 699 }
  };

  function updateAmount(){
    const role = document.getElementById("role").value;
    const plan = document.getElementById("plan").value;
    amountInput.value = PRICES[role][plan];
  }

  document.getElementById("role").onchange = updateAmount;
  document.getElementById("plan").onchange = updateAmount;
  updateAmount();

  listenUser(async (u)=>{
    if(!u){
      alert("Login required!");
      location.href="login.html";
      return;
    }

    currentUser = u;
    const isAdmin = (u.email === ADMIN_EMAIL);

    // ‚úÖ Admin UI
    if(isAdmin){
      if(adminLink) adminLink.style.display = "inline-block";
      if(adminBox){
        adminBox.innerHTML = `
          <div class="box" style="margin-top:14px;">
            <h3>üõ° ADMIN MODE ENABLED</h3>
            <p class="small">
              ‚úÖ Admin ko KYC requirement nahi hai.<br/>
              ‚úÖ Admin full access ‚úÖ
            </p>
          </div>
        `;
      }
      return; // ‚úÖ STOP here (NO KYC CHECK)
    }

    // ‚úÖ Normal user must have KYC approved
    const userSnap = await getDoc(doc(db,"users",u.uid));
    if(userSnap.exists()){
      const ud = userSnap.data();
      if(ud.kycStatus !== "APPROVED"){
        alert("KYC not approved! Pehle KYC approve karvao.");
        location.href="kyc.html";
      }
    }
  });

  // ‚úÖ Razorpay open
  window.payNow = function(){
    const role = document.getElementById("role").value;
    const plan = document.getElementById("plan").value;
    const amount = PRICES[role][plan];

    msg.innerHTML = "";

    if(amount === 0){
      payBox.innerHTML = `
        <div style="text-align:center;">
          <h3>‚úÖ Free Plan Selected</h3>
          <p class="small">Payment required nahi hai.</p>
        </div>
      `;
      return;
    }

    payBox.innerHTML = `
      <div style="text-align:center;">
        <p class="small">‚è≥ Opening Razorpay...</p>
      </div>
    `;

    var options = {
      key: RAZORPAY_KEY,
      amount: amount * 100,
      currency: "INR",
      name: "SP Verified Property India",
      description: `${role} - ${plan}`,
      handler: function (response) {
        alert("‚úÖ Payment Success: " + response.razorpay_payment_id);

        // ‚úÖ Auto fill UTR box
        document.getElementById("utr").value = response.razorpay_payment_id;

        payBox.innerHTML = `
          <div style="text-align:center;">
            <h3>‚úÖ Payment Done</h3>
            <p class="small">‡§Ö‡§¨ ‡§®‡•Ä‡§ö‡•á UTR Submit ‡§ï‡§∞ ‡§¶‡•á‡§Ç ‚úÖ</p>
          </div>
        `;
      },
      theme: { color: "#000000" }
    };

    var rzp1 = new Razorpay(options);
    rzp1.open();
  }

  // ‚úÖ Submit payment entry to Firestore (Admin Approval)
  window.submitPayment = async function(){
    if(!currentUser) return;

    const role = document.getElementById("role").value;
    const plan = document.getElementById("plan").value;
    const amount = PRICES[role][plan];
    const utr = document.getElementById("utr").value.trim();

    if(!utr){
      alert("UTR / Razorpay Payment ID required!");
      return;
    }

    await addDoc(collection(db,"payments"),{
      uid: currentUser.uid,
      email: currentUser.email,
      role,
      plan,
      amount,
      utr,
      upiId: UPI_ID,
      paymentMode: "RAZORPAY",
      status: "PENDING",
      createdAt: serverTimestamp()
    });

    msg.innerHTML = "‚úÖ Payment Submitted! Admin approval pending.";
    document.getElementById("utr").value = "";
  }
</script>

</body>
      </html>
