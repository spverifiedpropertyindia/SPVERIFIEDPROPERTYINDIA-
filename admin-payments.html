<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Payments - SP Verified Property India</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

<div class="nav">
  <div class="logo">üõ° Admin Payments</div>
  <div class="menu">
    <a href="dashboard.html">Dashboard</a>
    <a href="buy-plan.html">Buy Plan</a>
    <a href="admin-payments.html">Payments</a>
  </div>
</div>

<div class="container">

  <div class="box">
    <h2>‚úÖ Pending Payments</h2>
    <p class="small">Yaha admin payments approve/reject karega.</p>
    <div id="list"></div>
    <p class="small" id="msg" style="margin-top:10px;"></p>
  </div>

</div>

<script type="module">
  import { db } from "./js/firebase.js";
  import { listenUser } from "./js/auth.js";

  import {
    collection, query, where, orderBy, getDocs,
    doc, getDoc, updateDoc,
    serverTimestamp, Timestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const ADMIN_EMAIL = "raazsahu1000@gmail.com";

  const list = document.getElementById("list");
  const msg = document.getElementById("msg");

  // ‚úÖ Plan Days Map
  const PLAN_DAYS = {
    BASIC: 28,
    STANDARD: 56,
    PREMIUM: 84
  };

  function addDays(dateObj, days){
    const d = new Date(dateObj);
    d.setDate(d.getDate() + days);
    return d;
  }

  async function loadPayments(){
    list.innerHTML = "‚è≥ Loading...";
    msg.innerHTML = "";

    const q = query(
      collection(db, "payments"),
      where("status", "==", "PENDING"),
      orderBy("createdAt", "desc")
    );

    const snap = await getDocs(q);

    if(snap.empty){
      list.innerHTML = `<p class="small">‚úÖ No pending payments</p>`;
      return;
    }

    let html = "";
    snap.forEach((d)=>{
      const p = d.data();
      html += `
        <div class="box" style="margin-top:12px;">
          <h3>‚Çπ${p.amount} - ${p.plan}</h3>
          <p class="small">
            <b>Email:</b> ${p.email}<br/>
            <b>UID:</b> ${p.uid}<br/>
            <b>Role:</b> ${p.role}<br/>
            <b>UTR:</b> ${p.utr}<br/>
            <b>Status:</b> ${p.status}
          </p>

          <div style="display:flex;gap:10px;margin-top:10px;">
            <button class="btn" style="flex:1;" onclick="approvePayment('${d.id}')">
              ‚úÖ Approve
            </button>
            <button class="btn2" style="flex:1;" onclick="rejectPayment('${d.id}')">
              ‚ùå Reject
            </button>
          </div>
        </div>
      `;
    });

    list.innerHTML = html;
  }

  // ‚úÖ Approve Payment + Activate User Plan
  window.approvePayment = async function(paymentId){
    const payRef = doc(db, "payments", paymentId);
    const paySnap = await getDoc(payRef);

    if(!paySnap.exists()){
      alert("Payment not found!");
      return;
    }

    const pay = paySnap.data();

    const planDays = PLAN_DAYS[pay.plan] || 28;
    const startDate = new Date();
    const endDate = addDays(startDate, planDays);

    // ‚úÖ 1) Update payment status
    await updateDoc(payRef, {
      status: "APPROVED",
      approvedAt: serverTimestamp(),
      planDays: planDays
    });

    // ‚úÖ 2) Activate user plan
    await updateDoc(doc(db, "users", pay.uid), {
      planRole: pay.role,
      planType: pay.plan,
      planAmount: pay.amount,
      planStatus: "ACTIVE",
      paymentMode: pay.paymentMode || "UPI",
      utr: pay.utr,
      planDays: planDays,
      planStartAt: Timestamp.fromDate(startDate),
      planEndAt: Timestamp.fromDate(endDate),
      planUpdatedAt: serverTimestamp()
    });

    alert("‚úÖ Approved + User Plan Activated!");
    loadPayments();
  };

  // ‚úÖ Reject Payment
  window.rejectPayment = async function(paymentId){
    const reason = prompt("Reject reason (optional):") || "";

    await updateDoc(doc(db, "payments", paymentId), {
      status: "REJECTED",
      rejectedAt: serverTimestamp(),
      rejectReason: reason
    });

    alert("‚ùå Payment Rejected!");
    loadPayments();
  };

  // ‚úÖ Admin auth check
  listenUser(async (u)=>{
    if(!u){
      alert("Login required!");
      location.href = "login.html";
      return;
    }

    if(u.email !== ADMIN_EMAIL){
      alert("‚ùå Only admin allowed!");
      location.href = "dashboard.html";
      return;
    }

    loadPayments();
  });
</script>

</body>
</html>
