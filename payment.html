<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Payment Proof - SP Verified Property</title>

  <style>
    body{margin:0;font-family:Arial;background:#f6f7fb}
    header{background:#0b1b3a;color:#fff;padding:16px}
    .wrap{max-width:720px;margin:auto;padding:16px}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.08)}
    label{display:block;margin-top:10px;font-size:12px;color:#555;font-weight:800}
    input,select{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;margin-top:6px}
    button{width:100%;padding:12px;margin-top:14px;border:none;border-radius:12px;background:#0b1b3a;color:#fff;font-weight:900;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    a{color:#0b1b3a;text-decoration:none;font-weight:900}
    .mini{font-size:12px;color:#666;line-height:1.4;margin-top:10px}
    .err{font-size:12px;color:#c62828;font-weight:900;margin-top:8px}
    .ok{font-size:12px;color:#0f7a35;font-weight:900;margin-top:8px}
    .qrBox{margin-top:12px;border:1px solid #eee;border-radius:14px;padding:12px;text-align:center;background:#fafafa}
    .qrBox img{width:220px;height:220px;border-radius:12px;background:#fff;border:1px solid #eee}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#fff3cd;color:#7a5a00;font-weight:900;font-size:12px}
    .btnOrange{background:#ff7a00}
  </style>
</head>

<body>
<header><b>Upload Payment Proof ✅</b></header>

<div class="wrap">
  <div class="card">
    <p><a href="index.html">← Home</a></p>

    <div class="mini" id="statusBox">Loading...</div>

    <form id="payForm" style="margin-top:14px;display:none;">

      <div class="mini"><span class="pill">✅ Plan Select → Pay → Upload Proof</span></div>

      <label>Select Plan</label>
      <select id="plan" required>
        <option value="">Select</option>

        <optgroup label="OWNER Plans">
          <option value="OWNER_BASIC">Owner Basic (₹99)</option>
          <option value="OWNER_PLUS">Owner Plus (₹149)</option>
          <option value="OWNER_PREMIUM">Owner Premium (₹299)</option>
        </optgroup>

        <optgroup label="BROKER Plans">
          <option value="BROKER_BASIC">Broker Basic (₹499)</option>
          <option value="BROKER_PRO">Broker Pro (₹999)</option>
          <option value="BROKER_PREMIUM">Broker Premium (₹1499)</option>
        </optgroup>
      </select>

      <label>Amount (Auto)</label>
      <input id="amount" readonly placeholder="Select plan first"/>

      <label>UPI ID</label>
      <input id="upiId" readonly />

      <div class="qrBox">
        <div class="mini"><b>✅ Scan & Pay QR Code</b></div>
        <img id="qrImg" alt="UPI QR" />
        <div class="mini" id="upiLinkBox" style="margin-top:10px;"></div>

        <button type="button" id="openUpiBtn" class="btnOrange" disabled>
          Open UPI App ✅
        </button>
      </div>

      <label>Upload Payment Screenshot (Compulsory)</label>
      <input id="proofFile" type="file" accept="image/*" required />

      <div class="err" id="errBox"></div>
      <div class="ok" id="okBox"></div>

      <button id="submitBtn" type="submit" disabled>Submit Payment Proof ✅</button>
    </form>

    <div class="mini">
      ✅ Submit ke baad status <b>PENDING</b> रहेगा, Admin approve karega ✅
    </div>
  </div>
</div>

<script type="module">
  import { VPI } from "./vpi.js";

  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
  import { getFirestore, doc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";

  const storage = getStorage(getApp());
  const db = getFirestore(getApp());

  const statusBox = document.getElementById("statusBox");
  const payForm = document.getElementById("payForm");

  const planEl = document.getElementById("plan");
  const amountEl = document.getElementById("amount");
  const upiIdEl = document.getElementById("upiId");
  const proofFileEl = document.getElementById("proofFile");

  const qrImg = document.getElementById("qrImg");
  const upiLinkBox = document.getElementById("upiLinkBox");
  const openUpiBtn = document.getElementById("openUpiBtn");

  const errBox = document.getElementById("errBox");
  const okBox = document.getElementById("okBox");
  const submitBtn = document.getElementById("submitBtn");

  const UPI_ID = "8305070599@superyes";
  upiIdEl.value = UPI_ID;

  const PLAN_DATA = {
    OWNER_BASIC:   { amount: 99,   days: 30,  listings: 2 },
    OWNER_PLUS:    { amount: 149,  days: 45,  listings: 3 },
    OWNER_PREMIUM: { amount: 299,  days: 60,  listings: 999999 },

    BROKER_BASIC:  { amount: 499,  days: 30,  listings: 10 },
    BROKER_PRO:    { amount: 999,  days: 30,  listings: 25 },
    BROKER_PREMIUM:{ amount: 1499, days: 30,  listings: 999999 }
  };

  function qs(name){
    return new URLSearchParams(location.search).get(name);
  }

  function getAmount(plan){
    return PLAN_DATA[plan]?.amount || 0;
  }

  function buildUpiUri(plan, amount){
    const pa = encodeURIComponent(UPI_ID);
    const pn = encodeURIComponent("SP Verified Property");
    const tn = encodeURIComponent(`Plan: ${plan}`);
    return `upi://pay?pa=${pa}&pn=${pn}&am=${amount}&cu=INR&tn=${tn}`;
  }

  function buildQrUrl(text){
    return `https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=${encodeURIComponent(text)}`;
  }

  function refreshQr(){
    const plan = planEl.value;
    const amount = getAmount(plan);

    if(!plan){
      amountEl.value = "";
      qrImg.src = "";
      upiLinkBox.innerHTML = "";
      openUpiBtn.disabled = true;
      return;
    }

    amountEl.value = "₹" + amount;
    const upiUri = buildUpiUri(plan, amount);

    qrImg.src = buildQrUrl(upiUri);
    upiLinkBox.innerHTML = `✅ UPI Link: <a href="${upiUri}">${upiUri}</a>`;

    openUpiBtn.onclick = ()=>{ location.href = upiUri; };
    openUpiBtn.disabled = false;
  }

  function validate(){
    errBox.innerText = "";
    okBox.innerText = "";

    const plan = planEl.value;
    const amount = getAmount(plan);

    if(!plan){
      submitBtn.disabled = true;
      errBox.innerText = "❌ Plan select karo";
      return false;
    }

    if(!amount){
      submitBtn.disabled = true;
      errBox.innerText = "❌ Amount invalid";
      return false;
    }

    if(!proofFileEl.files || proofFileEl.files.length === 0){
      submitBtn.disabled = true;
      errBox.innerText = "❌ Payment screenshot upload compulsory hai";
      return false;
    }

    submitBtn.disabled = false;
    okBox.innerText = "✅ Ready to submit";
    return true;
  }

  planEl.addEventListener("change", ()=>{
    refreshQr();
    validate();
  });

  proofFileEl.addEventListener("change", validate);

  async function uploadProof(uid, file){
    const path = `payments/${uid}/${Date.now()}_payment_proof.jpg`;
    const r = ref(storage, path);
    await uploadBytes(r, file);
    return await getDownloadURL(r);
  }

  payForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!validate()) return;

    const u = VPI.currentUser();
    if(!u) return alert("❌ Login required");

    submitBtn.disabled = true;
    submitBtn.innerText = "Uploading...";

    try{
      const plan = planEl.value;
      const amount = getAmount(plan);
      const planDays = PLAN_DATA[plan]?.days || 0;
      const maxListings = PLAN_DATA[plan]?.listings || 0;

      const proofUrl = await uploadProof(u.uid, proofFileEl.files[0]);

      await setDoc(doc(db, "users", u.uid), {
        uid: u.uid,
        email: u.email
      }, { merge: true });

      await updateDoc(doc(db, "users", u.uid), {
        planSelected: plan,
        planAmount: amount,
        planDays: planDays,
        planMaxListings: maxListings,

        paymentProofUrl: proofUrl,
        paymentStatus: "PENDING",
        paymentSubmittedAt: serverTimestamp()
      });

      alert("✅ Payment Proof Submitted! Status = PENDING ✅");
      location.href = "index.html";

    }catch(err){
      alert("❌ Submit Failed: " + (err.message || err));
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit Payment Proof ✅";
    }
  });

  async function refresh(){
    const u = VPI.currentUser();
    if(!u){
      statusBox.innerHTML = `❌ Not logged in. <a href="user-login.html">Login</a>`;
      payForm.style.display = "none";
      return;
    }

    statusBox.innerHTML = `✅ Logged in: <b>${u.email}</b>`;
    payForm.style.display = "block";

    // ✅ Auto select plan from plans.html
    const pre = qs("plan");
    if(pre && PLAN_DATA[pre]){
      planEl.value = pre;
    }

    refreshQr();
    validate();
  }

  setTimeout(refresh, 800);
</script>

</body>
</html>