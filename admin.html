<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Panel - SP Verified Property</title>

  <style>
    body{margin:0;font-family:Arial;background:#f6f7fb}
    header{background:#0b1b3a;color:#fff;padding:16px}
    .wrap{max-width:1200px;margin:auto;padding:16px}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.08);margin-top:12px}
    a{color:#0b1b3a;text-decoration:none;font-weight:900}
    .mini{font-size:12px;color:#666;line-height:1.4}
    .title{font-size:18px;font-weight:900;margin:0}
    .sub{font-size:12px;color:#555;margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:10px;font-size:12px;text-align:left;vertical-align:top}
    th{background:#fafafa;font-weight:900}
    .btn{padding:8px 10px;border:none;border-radius:10px;font-weight:900;cursor:pointer}
    .btnOk{background:#0f7a35;color:#fff}
    .btnNo{background:#ff3b3b;color:#fff}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:900}
    .pending{background:#fff3cd;color:#7a5a00}
    .approved{background:#d4edda;color:#0f7a35}
    .rejected{background:#f8d7da;color:#a30000}
    input[type="text"]{width:100%;padding:10px;border:1px solid #ddd;border-radius:12px;margin-top:8px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
  </style>
</head>

<body>
<header><b>Admin Panel ‚úÖ</b></header>

<div class="wrap">
  <div class="card">
    <p><a href="index.html">‚Üê Home</a></p>
    <p class="title">Admin Dashboard ‚úÖ</p>
    <p class="sub" id="adminStatus">Loading...</p>
  </div>

  <!-- ‚úÖ KYC -->
  <div class="card">
    <p class="title">KYC Approvals (Pending)</p>
    <p class="mini">‚úÖ Aadhaar/PAN/Voter + Selfie verify ‡§ï‡§∞‡§ï‡•á approve/reject ‡§ï‡§∞‡•ã</p>

    <div id="kycBox" class="mini">Loading pending KYC...</div>

    <table id="kycTable" style="display:none;">
      <thead>
        <tr>
          <th>User</th>
          <th>KYC</th>
          <th>Documents</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="kycTbody"></tbody>
    </table>
  </div>

  <!-- ‚úÖ PAYMENT -->
  <div class="card">
    <p class="title">Payment Proof Approvals (Pending)</p>
    <p class="mini">‚úÖ Payment screenshot check ‡§ï‡§∞‡§ï‡•á approve/reject ‡§ï‡§∞‡•ã</p>

    <div id="payBox" class="mini">Loading pending payments...</div>

    <table id="payTable" style="display:none;">
      <thead>
        <tr>
          <th>User</th>
          <th>Plan</th>
          <th>Proof</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="payTbody"></tbody>
    </table>
  </div>

  <!-- ‚úÖ PROPERTIES -->
  <div class="card">
    <p class="title">Property Verify (Pending)</p>
    <p class="mini">‚úÖ Strict Camera Photos + GPS check ‡§ï‡§∞‡§ï‡•á approve/reject ‡§ï‡§∞‡•ã</p>

    <div id="propBox" class="mini">Loading pending properties...</div>

    <table id="propTable" style="display:none;">
      <thead>
        <tr>
          <th>Owner</th>
          <th>Property</th>
          <th>GPS + Photos</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="propTbody"></tbody>
    </table>
  </div>
</div>

<script type="module">
  import { VPI } from "./vpi.js";

  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    doc,
    updateDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  import { getApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";

  const db = getFirestore(getApp());

  const adminStatus = document.getElementById("adminStatus");

  // ‚úÖ KYC UI
  const kycBox = document.getElementById("kycBox");
  const kycTable = document.getElementById("kycTable");
  const kycTbody = document.getElementById("kycTbody");

  // ‚úÖ PAYMENT UI
  const payBox = document.getElementById("payBox");
  const payTable = document.getElementById("payTable");
  const payTbody = document.getElementById("payTbody");

  // ‚úÖ Property UI
  const propBox = document.getElementById("propBox");
  const propTable = document.getElementById("propTable");
  const propTbody = document.getElementById("propTbody");

  function safe(v){ return (v===undefined || v===null) ? "" : String(v); }

  function link(url, text="Open"){
    if(!url) return "";
    return `<a href="${url}" target="_blank">${text}</a>`;
  }

  function pill(status){
    if(status === "APPROVED") return `<span class="pill approved">APPROVED</span>`;
    if(status === "REJECTED") return `<span class="pill rejected">REJECTED</span>`;
    return `<span class="pill pending">PENDING</span>`;
  }

  // ‚úÖ LOAD KYC PENDING
  async function loadKycPending(){
    kycBox.innerHTML = "‚è≥ Loading...";
    kycTbody.innerHTML = "";

    const q1 = query(collection(db, "users"), where("kycStatus", "==", "PENDING"));
    const snap = await getDocs(q1);

    if(snap.empty){
      kycBox.innerHTML = "‚úÖ No pending KYC found.";
      kycTable.style.display = "none";
      return;
    }

    kycBox.innerHTML = `‚úÖ Pending KYC: <b>${snap.size}</b>`;
    kycTable.style.display = "table";

    snap.forEach((d)=>{
      const u = d.data();
      const uid = d.id;

      const email = safe(u.email);
      const type = safe(u.kycType);
      const number = safe(u.kycNumber);

      const front = safe(u.kycDocFrontUrl);
      const back = safe(u.kycDocBackUrl);
      const single = safe(u.kycDocSingleUrl);
      const selfie = safe(u.kycSelfieUrl);

      const docsHtml = `
        ${front ? "Front: " + link(front,"View") + "<br/>" : ""}
        ${back ? "Back: " + link(back,"View") + "<br/>" : ""}
        ${single ? "Doc: " + link(single,"View") + "<br/>" : ""}
        ${selfie ? "Selfie: " + link(selfie,"View") + "<br/>" : ""}
      `;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <b>${email || "No Email"}</b><br/>
          <span class="mini">UID: ${uid}</span><br/>
          ${pill("PENDING")}
        </td>
        <td>
          <b>${type}</b><br/>
          <span class="mini">${number}</span>
        </td>
        <td>${docsHtml || "<span class='mini'>No docs</span>"}</td>
        <td style="min-width:190px;">
          <button class="btn btnOk" data-kyc-approve="${uid}">Approve ‚úÖ</button>
          <button class="btn btnNo" data-kyc-reject="${uid}">Reject ‚ùå</button>
          <input type="text" placeholder="Reject reason (optional)" id="kyc_reason_${uid}">
        </td>
      `;
      kycTbody.appendChild(tr);
    });

    document.querySelectorAll("[data-kyc-approve]").forEach(btn=>{
      btn.onclick = async ()=>{
        const uid = btn.getAttribute("data-kyc-approve");
        if(!confirm("‚úÖ Approve this KYC?")) return;

        await updateDoc(doc(db, "users", uid), {
          kycStatus: "APPROVED",
          kycApprovedAt: serverTimestamp(),
          kycApprovedBy: VPI.currentUser()?.email || "admin"
        });

        alert("‚úÖ KYC Approved!");
        loadKycPending();
      };
    });

    document.querySelectorAll("[data-kyc-reject]").forEach(btn=>{
      btn.onclick = async ()=>{
        const uid = btn.getAttribute("data-kyc-reject");
        const reason = (document.getElementById("kyc_reason_" + uid)?.value || "").trim();

        if(!confirm("‚ùå Reject this KYC?")) return;

        await updateDoc(doc(db, "users", uid), {
          kycStatus: "REJECTED",
          kycRejectedAt: serverTimestamp(),
          kycRejectedBy: VPI.currentUser()?.email || "admin",
          kycRejectReason: reason || "Rejected by admin"
        });

        alert("‚úÖ KYC Rejected!");
        loadKycPending();
      };
    });
  }

  // ‚úÖ LOAD PAYMENT PENDING
  async function loadPaymentPending(){
    payBox.innerHTML = "‚è≥ Loading...";
    payTbody.innerHTML = "";

    const q2 = query(collection(db, "users"), where("paymentStatus", "==", "PENDING"));
    const snap = await getDocs(q2);

    if(snap.empty){
      payBox.innerHTML = "‚úÖ No pending payments found.";
      payTable.style.display = "none";
      return;
    }

    payBox.innerHTML = `‚úÖ Pending Payments: <b>${snap.size}</b>`;
    payTable.style.display = "table";

    snap.forEach((d)=>{
      const u = d.data();
      const uid = d.id;

      const email = safe(u.email);
      const plan = safe(u.planSelected);
      const amt = safe(u.planAmount);
      const proof = safe(u.paymentProofUrl);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <b>${email || "No Email"}</b><br/>
          <span class="mini">UID: ${uid}</span><br/>
          ${pill("PENDING")}
        </td>
        <td>
          <b>${plan || "-"}</b><br/>
          <span class="mini">‚Çπ${amt || "-"}</span>
        </td>
        <td>
          ${proof ? link(proof,"View Proof") : "<span class='mini'>No proof</span>"}
        </td>
        <td style="min-width:190px;">
          <button class="btn btnOk" data-pay-approve="${uid}">Approve ‚úÖ</button>
          <button class="btn btnNo" data-pay-reject="${uid}">Reject ‚ùå</button>
          <input type="text" placeholder="Reject reason (optional)" id="pay_reason_${uid}">
        </td>
      `;
      payTbody.appendChild(tr);
    });

    document.querySelectorAll("[data-pay-approve]").forEach(btn=>{
      btn.onclick = async ()=>{
        const uid = btn.getAttribute("data-pay-approve");
        if(!confirm("‚úÖ Approve payment proof?")) return;

        await updateDoc(doc(db, "users", uid), {
          paymentStatus: "APPROVED",
          paymentApprovedAt: serverTimestamp(),
          paymentApprovedBy: VPI.currentUser()?.email || "admin"
        });

        alert("‚úÖ Payment Approved!");
        loadPaymentPending();
      };
    });

    document.querySelectorAll("[data-pay-reject]").forEach(btn=>{
      btn.onclick = async ()=>{
        const uid = btn.getAttribute("data-pay-reject");
        const reason = (document.getElementById("pay_reason_" + uid)?.value || "").trim();

        if(!confirm("‚ùå Reject payment proof?")) return;

        await updateDoc(doc(db, "users", uid), {
          paymentStatus: "REJECTED",
          paymentRejectedAt: serverTimestamp(),
          paymentRejectedBy: VPI.currentUser()?.email || "admin",
          paymentRejectReason: reason || "Rejected by admin"
        });

        alert("‚úÖ Payment Rejected!");
        loadPaymentPending();
      };
    });
  }

  // ‚úÖ LOAD PROPERTY PENDING
  async function loadPropertyPending(){
    propBox.innerHTML = "‚è≥ Loading...";
    propTbody.innerHTML = "";

    const q3 = query(collection(db, "properties"), where("status", "==", "PENDING"));
    const snap = await getDocs(q3);

    if(snap.empty){
      propBox.innerHTML = "‚úÖ No pending properties found.";
      propTable.style.display = "none";
      return;
    }

    propBox.innerHTML = `‚úÖ Pending Properties: <b>${snap.size}</b>`;
    propTable.style.display = "table";

    snap.forEach((d)=>{
      const p = d.data();
      const pid = d.id;

      const ownerEmail = safe(p.ownerEmail);
      const ownerPhone = safe(p.ownerPhone);
      const title = safe(p.title);
      const type = safe(p.type);
      const price = safe(p.price);
      const address = safe(p.address);

      const gpsLat = safe(p.gpsLat);
      const gpsLng = safe(p.gpsLng);
      const map = safe(p.gpsMapLink);

      const photos = Array.isArray(p.photos) ? p.photos : [];
      const firstPhoto = photos[0] || "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <b>${ownerEmail || "No email"}</b><br/>
          <span class="mini">Phone: ${ownerPhone || "-"}</span><br/>
          <span class="mini">UID: ${safe(p.uid)}</span><br/>
          ${pill("PENDING")}
        </td>

        <td>
          <b>${title}</b><br/>
          <span class="mini">${type} | ‚Çπ${price}</span><br/>
          <span class="mini">${address}</span>
        </td>

        <td>
          ${map ? link(map,"Open Map üìç") : "<span class='mini'>No Map</span>"}<br/>
          <span class="mini">${gpsLat}, ${gpsLng}</span><br/>
          ${firstPhoto ? link(firstPhoto,"View Photo") : "<span class='mini'>No Photo</span>"}<br/>
          <span class="mini">Photos: ${photos.length}</span>
        </td>

        <td style="min-width:190px;">
          <button class="btn btnOk" data-prop-approve="${pid}">Verify ‚úÖ</button>
          <button class="btn btnNo" data-prop-reject="${pid}">Reject ‚ùå</button>
        </td>
      `;
      propTbody.appendChild(tr);
    });

    document.querySelectorAll("[data-prop-approve]").forEach(btn=>{
      btn.onclick = async ()=>{
        const pid = btn.getAttribute("data-prop-approve");
        if(!confirm("‚úÖ Verify/Approve this property?")) return;

        await updateDoc(doc(db, "properties", pid), {
          status: "APPROVED",
          approvedAt: serverTimestamp(),
          approvedBy: VPI.currentUser()?.email || "admin"
        });

        alert("‚úÖ Property Verified!");
        loadPropertyPending();
      };
    });

    document.querySelectorAll("[data-prop-reject]").forEach(btn=>{
      btn.onclick = async ()=>{
        const pid = btn.getAttribute("data-prop-reject");
        if(!confirm("‚ùå Reject this property?")) return;

        await updateDoc(doc(db, "properties", pid), {
          status: "REJECTED",
          rejectedAt: serverTimestamp(),
          rejectedBy: VPI.currentUser()?.email || "admin"
        });

        alert("‚úÖ Property Rejected!");
        loadPropertyPending();
      };
    });
  }

  async function init(){
    setTimeout(()=>{
      VPI.requireAdmin();
      adminStatus.innerHTML = `‚úÖ Admin Logged In: <b>${VPI.currentUser()?.email}</b>`;
    }, 800);

    await loadKycPending();
    await loadPaymentPending();
    await loadPropertyPending();
  }

  init();
</script>

</body>
</html>