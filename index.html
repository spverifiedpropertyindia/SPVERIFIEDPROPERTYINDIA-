
<script type="module">
  // ✅ Firebase Config (Aapka same rahega - apna config paste)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    // ✅ apna firebase config yaha paste karein
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const ADMIN_EMAIL = "raazsahu1000@gmail.com";

  function nowMs() { return Date.now(); }

  async function getUserDoc(uid) {
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    return { ref, data: snap.exists() ? snap.data() : null };
  }

  function isPlanActive(userData) {
    if (!userData) return false;
    if (userData.planStatus !== "ACTIVE") return false;
    if (!userData.planExpiryAt) return false;

    const expiryMs = userData.planExpiryAt?.toMillis ? userData.planExpiryAt.toMillis() : 0;
    return expiryMs > nowMs();
  }

  async function autoExpireIfNeeded(userRef, userData) {
    if (!userData || !userData.planExpiryAt) return;

    const expiryMs = userData.planExpiryAt?.toMillis ? userData.planExpiryAt.toMillis() : 0;

    if (userData.planStatus === "ACTIVE" && expiryMs <= nowMs()) {
      await updateDoc(userRef, {
        planStatus: "EXPIRED",
        updatedAt: serverTimestamp()
      });
    }
  }

  async function protectPage(options = { requireKyc: true, requirePlan: true }) {
    return new Promise((resolve) => {
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "user-login.html";
          return;
        }

        // ✅ Admin full pass
        if (user.email === ADMIN_EMAIL) {
          resolve({ user, role: "admin" });
          return;
        }

        const { ref: userRef, data: userData } = await getUserDoc(user.uid);

        // ✅ new user setup
        if (!userData) {
          window.location.href = "user-setup.html";
          return;
        }

        // ✅ auto expire plan
        await autoExpireIfNeeded(userRef, userData);

        // ✅ KYC Gate
        if (options.requireKyc) {
          const kycStatus = userData.kycStatus || "PENDING";
          if (kycStatus !== "APPROVED") {
            window.location.href = "kyc.html";
            return;
          }
        }

        // ✅ Plan Gate
        if (options.requirePlan) {
          const active = isPlanActive(userData);
          if (!active) {
            window.location.href = "plans.html";
            return;
          }
        }

        resolve({ user, role: userData.role || "user", userData });
      });
    });
  }

  // ✅ LOGOUT GLOBAL
  window.logoutNow = async () => {
    await signOut(auth);
    window.location.href = "user-login.html";
  };

  // ✅ PROTECT CURRENT PAGE
  protectPage({ requireKyc: true, requirePlan: true });
</script>