<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <!-- ‚úÖ FORCE CORRECT DOMAIN -->
  <script>
    if (location.hostname === "pverifiedpropertyindia.github.io") {
      location.replace("https://spverifiedpropertyindia.github.io/SPVERIFIEDPROPERTYINDIA-/");
    }
  </script>

  <title>SP Verified Property - Dashboard (PRO)</title>

  <style>
    body{margin:0;font-family:Arial;background:#f6f7fb}
    header{background:#0b1b3a;color:#fff;padding:16px}
    .wrap{max-width:950px;margin:auto;padding:16px}

    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.08);margin-top:12px}
    a.btn,button.btn{
      display:block;padding:12px;border-radius:12px;background:#0b1b3a;color:#fff;
      text-decoration:none;font-weight:900;margin-top:10px;text-align:center;border:none;width:100%;cursor:pointer
    }
    .btn.red{background:#ff3b3b}
    .btn.green{background:#22c55e}
    .btn.orange{background:#ff7a00}
    .btn.gray{background:#64748b}

    .mini{font-size:12px;color:#666}
    .title{font-size:16px;font-weight:900;color:#0b1b3a;margin:0 0 6px}

    .box{background:#f1f3ff;border:1px solid #dfe3ff;padding:12px;border-radius:14px;margin-top:10px}

    ul{margin:8px 0 0 18px;padding:0}
    li{margin:6px 0}

    .badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;display:inline-block}
    .b2{background:#dcfce7;color:#166534}
    .b3{background:#fee2e2;color:#991b1b}
    .b4{background:#fef9c3;color:#854d0e}

    .supportBox{background:#fff7ed;border:1px solid #ffd8a8;padding:12px;border-radius:14px;margin-top:12px}

    /* ‚úÖ NEW: Reminder UI */
    .alertBox{
      padding:12px;border-radius:14px;margin-top:10px;font-weight:900
    }
    .alertGreen{background:#dcfce7;border:1px solid #86efac;color:#166534}
    .alertYellow{background:#fef9c3;border:1px solid #fde047;color:#854d0e}
    .alertRed{background:#fee2e2;border:1px solid #fecaca;color:#991b1b}
  </style>
</head>

<body>
<header><b>Dashboard ‚úÖ (PRO)</b></header>

<div class="wrap">

  <div class="card">
    <div class="mini" id="status">Loading...</div>

    <div class="box">
      <p class="title">‚úÖ Account Status</p>
      <div class="mini" id="kycLine">KYC: ...</div>
      <div class="mini" id="planLine">Plan: ...</div>
      <div class="mini" id="expLine">Expiry: ...</div>
      <div class="mini" id="lockMsg" style="margin-top:8px;font-weight:900;"></div>

      <!-- ‚úÖ NEW: Plan Reminder Box -->
      <div id="reminderBox" style="display:none;" class="alertBox"></div>

      <!-- ‚úÖ NEW: Renew Plan Button -->
      <a class="btn orange" id="renewBtn" href="plans.html" style="display:none;">Renew Plan Now ‚úÖ</a>
    </div>

    <a class="btn gray" href="user-setup.html">User Setup</a>
    <a class="btn orange" href="kyc.html">KYC Submit (PRO)</a>
    <a class="btn orange" href="plans.html">Plans</a>
    <a class="btn orange" href="payment.html">Upload Payment Proof (PRO)</a>

    <a class="btn green" href="add-property.html" id="addPropBtn">Add Property (PRO)</a>
    <a class="btn" href="listings.html">Public Listings</a>

    <a class="btn" href="admin.html" id="adminBtn" style="display:none;">Admin Panel ‚úÖ</a>

    <button class="btn red" id="logoutBtn">Logout</button>
  </div>

  <div class="card">
    <p class="title">‚úÖ Website Full Process (PRO)</p>
    <div class="box">
      <ul class="mini">
        <li><b>Step 1:</b> Google Login ‚úÖ</li>
        <li><b>Step 2:</b> User Setup ‚úÖ</li>
        <li><b>Step 3:</b> KYC Upload + Live Photo ‚úÖ</li>
        <li><b>Step 4:</b> Plan Select ‚úÖ</li>
        <li><b>Step 5:</b> Payment Screenshot Upload ‚úÖ</li>
        <li><b>Step 6:</b> Plan Activation by Admin ‚úÖ</li>
        <li><b>Step 7:</b> Add Property (Min 3 Photos + GPS) ‚úÖ</li>
        <li><b>Step 8:</b> Admin Property Approval ‚úÖ</li>
      </ul>
    </div>
  </div>

  <div class="card">
    <p class="title">‚úÖ Support / Contact</p>
    <div class="supportBox mini">
      üìû Mobile: <b>8305070599</b><br/>
      üìß Email: <b>spverifiedproperty@gmail.com</b><br/>
      üïô Working Time: <b>10 AM - 4 PM</b>

      <a class="btn green" href="https://wa.me/918305070599" target="_blank">WhatsApp Support ‚úÖ</a>
      <a class="btn orange" href="tel:8305070599">Call Now ‚úÖ</a>
      <a class="btn" href="mailto:spverifiedproperty@gmail.com">Email Support ‚úÖ</a>
    </div>
  </div>

</div>

<script type="module">
  import { VPI } from "./vpi.js?v=2";

  import { getFirestore, doc, getDoc }
    from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";

  const db = getFirestore(getApp());

  const status = document.getElementById("status");
  const kycLine = document.getElementById("kycLine");
  const planLine = document.getElementById("planLine");
  const expLine = document.getElementById("expLine");
  const lockMsg = document.getElementById("lockMsg");

  const reminderBox = document.getElementById("reminderBox");
  const renewBtn = document.getElementById("renewBtn");

  const addPropBtn = document.getElementById("addPropBtn");
  const adminBtn = document.getElementById("adminBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  function badge(s){
    const x = (s||"PENDING").toUpperCase();
    if(x==="APPROVED") return `<span class="badge b2">APPROVED</span>`;
    if(x==="ACTIVE") return `<span class="badge b2">ACTIVE</span>`;
    if(x==="REJECTED") return `<span class="badge b3">REJECTED</span>`;
    return `<span class="badge b4">${x}</span>`;
  }

  function toDateSafe(ts){
    if(!ts) return null;
    if(ts.toDate) return ts.toDate();
    return new Date(ts);
  }

  // ‚úÖ NEW: Reminder system (1 time per day per user)
  function todayKey(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function canShowReminder(uid){
    try{
      const k = `planReminder_${uid}_${todayKey()}`;
      const already = localStorage.getItem(k);
      if(already) return false;
      localStorage.setItem(k, "1");
      return true;
    }catch(e){
      return true; // ‡§Ö‡§ó‡§∞ localstorage blocked ‡§π‡•ã ‡§§‡•ã ‡§≠‡•Ä reminder ‡§ö‡§≤‡•á
    }
  }

  function showReminderUI(type, text){
    reminderBox.style.display = "block";
    reminderBox.className = "alertBox " + type;
    reminderBox.innerHTML = text;
  }

  async function refresh(){
    const u = VPI.currentUser();

    if(!u){
      status.innerHTML = `‚ùå Not logged in. <a href="user-login.html">Login</a>`;
      return;
    }

    status.innerHTML = `‚úÖ Logged in: <b>${u.email}</b> ${VPI.isAdmin() ? "(ADMIN ‚úÖ)" : ""}`;

    adminBtn.style.display = VPI.isAdmin() ? "block" : "none";

    try{
      const snap = await getDoc(doc(db,"users", u.uid));
      if(!snap.exists()){
        kycLine.innerHTML = `KYC: ${badge("PENDING")}`;
        planLine.innerHTML = `Plan: ${badge("PENDING")}`;
        expLine.innerHTML = `Expiry: -`;
        lockMsg.innerHTML = "‚ö†Ô∏è Please complete User Setup first ‚úÖ";

        reminderBox.style.display = "none";
        renewBtn.style.display = "none";

        addPropBtn.style.pointerEvents = "none";
        addPropBtn.style.opacity = "0.5";
        return;
      }

      const data = snap.data();

      const kycStatus = data.kycStatus || "PENDING";
      const planStatus = data.planStatus || "PENDING";
      const planSelected = data.planSelected || "-";

      kycLine.innerHTML = `KYC: ${badge(kycStatus)}`;
      planLine.innerHTML = `Plan: <b>${planSelected}</b> ${badge(planStatus)}`;

      const expiresAt = toDateSafe(data.planExpiresAt);

      // ‚úÖ Reset reminder UI each refresh
      reminderBox.style.display = "none";
      renewBtn.style.display = "none";

      if(expiresAt){
        const now = new Date();
        const diffMs = expiresAt.getTime() - now.getTime();
        const daysLeft = Math.ceil(diffMs / (1000*60*60*24));

        if(daysLeft <= 0){
          expLine.innerHTML = `Expiry: <b>Expired</b>`;
          renewBtn.style.display = "block";

          showReminderUI("alertRed", `‚ùå ‡§Ü‡§™‡§ï‡§æ Plan Expire ‡§π‡•ã ‡§ö‡•Å‡§ï‡§æ ‡§π‡•à! ‡§Ö‡§≠‡•Ä Renew ‡§ï‡§∞‡•á‡§Ç ‚úÖ`);

          // ‚úÖ popup reminder (only once per day)
          if(canShowReminder(u.uid)){
            alert("‚ùå ‡§Ü‡§™‡§ï‡§æ Plan Expire ‡§π‡•ã ‡§ö‡•Å‡§ï‡§æ ‡§π‡•à! ‡§Ö‡§≠‡•Ä Renew ‡§ï‡§∞‡•ã ‚úÖ");
          }

        }else{
          expLine.innerHTML = `Expiry: <b>${daysLeft} days left</b>`;

          // ‚úÖ Warning reminders
          if(daysLeft <= 3){
            renewBtn.style.display = "block";
            showReminderUI("alertYellow", `‚ö†Ô∏è ‡§Ü‡§™‡§ï‡§æ Plan <b>${daysLeft} ‡§¶‡§ø‡§®</b> ‡§Æ‡•á‡§Ç expire ‡§π‡•ã‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§π‡•à‡•§ ‡§Ö‡§≠‡•Ä Renew ‡§ï‡§∞ ‡§≤‡•ã ‚úÖ`);

            if(canShowReminder(u.uid)){
              alert(`‚ö†Ô∏è ‡§Ü‡§™‡§ï‡§æ Plan ${daysLeft} ‡§¶‡§ø‡§® ‡§Æ‡•á‡§Ç expire ‡§π‡•ã‡§ó‡§æ‡•§ ‡§Ö‡§≠‡•Ä Renew ‡§ï‡§∞ ‡§≤‡•ã ‚úÖ`);
            }
          }else{
            // ‚úÖ plan ok
            showReminderUI("alertGreen", `‚úÖ ‡§Ü‡§™‡§ï‡§æ Plan Active ‡§π‡•à‡•§ No problem ‚úÖ`);
          }
        }
      }else{
        expLine.innerHTML = `Expiry: -`;

        // ‚úÖ ‡§Ö‡§ó‡§∞ expiry ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§§‡•ã ‡§≠‡•Ä suggestion
        if(planStatus === "ACTIVE"){
          showReminderUI("alertYellow", `‚ö†Ô∏è Plan Active ‡§π‡•à ‡§≤‡•á‡§ï‡§ø‡§® Expiry date ‡§∏‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ Admin ‡§∏‡•á expiry update ‡§ï‡§∞‡§µ‡§æ‡§ì ‚úÖ`);
        }else{
          showReminderUI("alertYellow", `‚ö†Ô∏è Plan Select ‡§ï‡§∞‡§ï‡•á payment ‡§ï‡§∞‡•ã ‚úÖ`);
        }
      }

      // ‚úÖ LOCK LOGIC FOR ADD PROPERTY
      let lockText = "";

      if(kycStatus !== "APPROVED"){
        lockText = "üîí Property Add Locked: KYC approval pending ‚úÖ";
      } else if(planStatus !== "ACTIVE"){
        lockText = "üîí Property Add Locked: Plan not active ‚úÖ";
      } else if(expiresAt && expiresAt.getTime() < new Date().getTime()){
        lockText = "üîí Property Add Locked: Plan expired ‚úÖ";
      } else {
        lockText = "‚úÖ All Verified! You can add property ‚úÖ";
      }

      lockMsg.innerHTML = lockText;

      const unlocked = (kycStatus==="APPROVED" && planStatus==="ACTIVE" && (!expiresAt || expiresAt.getTime() > new Date().getTime()));

      addPropBtn.style.pointerEvents = unlocked ? "auto" : "none";
      addPropBtn.style.opacity = unlocked ? "1" : "0.5";

    }catch(e){
      console.log(e);
      lockMsg.innerHTML = "‚ùå Error loading status";
    }
  }

  logoutBtn.onclick = async ()=>{
    await VPI.logout();
    location.href = "user-login.html";
  };

  // ‚úÖ Refresh every 5 seconds (1 second ‡§Æ‡§§ ‡§ï‡§∞‡•ã)
  setInterval(refresh, 5000);
  refresh();
</script>

</body>
</html>